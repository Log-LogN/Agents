from .nvd_client import fetch_cves
from .common import success, failure


def parse_results(data):
    results = []

    for item in data.get("vulnerabilities", []):
        cve = item.get("cve", {})
        metrics = cve.get("metrics", {})

        severity = "UNKNOWN"
        score = None

        if "cvssMetricV31" in metrics:
            cvss = metrics["cvssMetricV31"][0]["cvssData"]
            severity = cvss.get("baseSeverity")
            score = cvss.get("baseScore")

        description = ""
        if cve.get("descriptions"):
            description = cve["descriptions"][0].get("value", "")[:200]

        results.append({
            "cve_id": cve.get("id"),
            "severity": severity,
            "score": score,
            "description": description,
        })

    return results


def search_keyword(keyword: str, limit: int = 5):
    try:
        data = fetch_cves(keyword, limit)
        results = parse_results(data)

        return success({
            "keyword": keyword,
            "count": len(results),
            "results": results
        })

    except Exception as e:
        return failure(str(e))


def search_product(product: str, version: str):
    normalized = product.replace("-", " ")
    keyword = f"{normalized} {version}"
    return search_keyword(keyword)