from .nvd_client import fetch_cves
from .common import success, failure


def parse_results(data):
    results = []

    for item in data.get("vulnerabilities", []):
        cve = item.get("cve", {})
        metrics = cve.get("metrics", {})

        severity = "UNKNOWN"
        score = None

        if "cvssMetricV31" in metrics:
            cvss = metrics["cvssMetricV31"][0]["cvssData"]
            severity = cvss.get("baseSeverity")
            score = cvss.get("baseScore")

        description = ""
        if cve.get("descriptions"):
            description = cve["descriptions"][0].get("value", "")[:200]

        results.append({
            "cve_id": cve.get("id"),
            "severity": severity,
            "score": score,
            "description": description,
        })

    return results


def search_keyword(keyword: str, limit: int = 5):
    try:
        data = fetch_cves(keyword, limit)
        results = parse_results(data)

        return success({
            "keyword": keyword,
            "count": len(results),
            "results": results
        })

    except Exception as e:
        return failure(str(e))


def search_product(product: str, version: str):
    normalized = product.replace("-", " ")
    keyword = f"{normalized} {version}"
    return search_keyword(keyword)


def get_cvss_score(cve: str) -> dict:
    """
    Fetch a single CVSS base score for a CVE (best-effort via NVD keyword search).
    """
    try:
        cve_norm = (cve or "").strip().upper()
        if not cve_norm.startswith("CVE-"):
            return failure("Invalid CVE format.")

        data = fetch_cves(cve_norm, limit=10)
        results = parse_results(data)

        for r in results:
            if (r.get("cve_id") or "").upper() == cve_norm and r.get("score") is not None:
                return success({"cve": cve_norm, "cvss": float(r["score"])})

        for r in results:
            if r.get("score") is not None:
                return success({"cve": cve_norm, "cvss": float(r["score"])})

        return failure(f"CVSS score not found for {cve_norm}.")
    except Exception as e:
        return failure(str(e))
