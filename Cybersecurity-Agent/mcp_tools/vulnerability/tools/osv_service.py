from .osv_client import query_osv
from .common import success, failure


def parse_osv(data):
    vulns = []

    for v in data.get("vulns", []):
        vulns.append({
            "id": v.get("id"),
            "summary": v.get("summary"),
            "severity": v.get("database_specific", {}).get("severity"),
        })

    return vulns


def maven_lookup(artifact: str, version: str):
    """
    Maven lookup supports:
    - artifact only (log4j-core)
    - group:artifact (org.apache.logging.log4j:log4j-core)
    """
    try:
        data = query_osv(artifact, version, "Maven")

        vulns = parse_osv(data)

        # If nothing found and artifact has no group, try common fallback
        if not vulns and ":" not in artifact:
            fallback = f"org.apache.logging.log4j:{artifact}"
            data = query_osv(fallback, version, "Maven")
            vulns = parse_osv(data)

        return success({
            "artifact": artifact,
            "version": version,
            "count": len(vulns),
            "vulnerabilities": vulns
        })

    except Exception as e:
        return failure(str(e))


def package_lookup(name: str, version: str, ecosystem: str):
    try:
        data = query_osv(name, version, ecosystem)
        vulns = parse_osv(data)

        return success({
            "package": name,
            "version": version,
            "ecosystem": ecosystem,
            "count": len(vulns),
            "vulnerabilities": vulns
        })

    except Exception as e:
        return failure(str(e))


def cross_verify_package(name: str, version: str, ecosystem: str):
    """
    Cross-verify vulnerabilities using both OSV and NVD for better accuracy.
    """
    try:
        # Get OSV results
        osv_result = package_lookup(name, version, ecosystem)
        osv_vulns = []
        if osv_result["status"] == "success":
            osv_vulns = osv_result["data"]["vulnerabilities"]

        # Get NVD results (using product search)
        from .nvd_service import search_product
        nvd_result = search_product(name, version)
        nvd_vulns = []
        if nvd_result["status"] == "success":
            nvd_vulns = nvd_result["data"]["results"]

        # Combine unique vulnerabilities
        combined_vulns = osv_vulns + nvd_vulns
        # Remove duplicates based on ID
        seen_ids = set()
        unique_vulns = []
        for v in combined_vulns:
            vid = v.get("id") or v.get("cve_id")
            if vid and vid not in seen_ids:
                seen_ids.add(vid)
                unique_vulns.append(v)

        return success({
            "package": name,
            "version": version,
            "ecosystem": ecosystem,
            "osv_count": len(osv_vulns),
            "nvd_count": len(nvd_vulns),
            "combined_count": len(unique_vulns),
            "vulnerabilities": unique_vulns
        })

    except Exception as e:
        return failure(str(e))
