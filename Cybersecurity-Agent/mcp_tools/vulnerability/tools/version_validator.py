import requests
from .common import success, failure

def validate_npm_version(package: str, version: str):
    """
    Validate if a package version exists on npm registry.
    """
    try:
        url = f"https://registry.npmjs.org/{package}/{version}"
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            data = response.json()
            if data.get("version") == version:
                return success({
                    "package": package,
                    "version": version,
                    "ecosystem": "npm",
                    "exists": True,
                    "latest": data.get("dist-tags", {}).get("latest")
                })
        return success({
            "package": package,
            "version": version,
            "ecosystem": "npm",
            "exists": False
        })
    except Exception as e:
        return failure(str(e))

def validate_pypi_version(package: str, version: str):
    """
    Validate if a package version exists on PyPI.
    """
    try:
        url = f"https://pypi.org/pypi/{package}/json"
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            data = response.json()
            releases = data.get("releases", {})
            if version in releases:
                return success({
                    "package": package,
                    "version": version,
                    "ecosystem": "PyPI",
                    "exists": True,
                    "latest": data.get("info", {}).get("version")
                })
        return success({
            "package": package,
            "version": version,
            "ecosystem": "PyPI",
            "exists": False
        })
    except Exception as e:
        return failure(str(e))

def validate_maven_version(group: str, artifact: str, version: str):
    """
    Validate if a Maven artifact version exists on Maven Central.
    If group is empty, search for the artifact to find the group.
    """
    try:
        if not group:
            # Search for artifact to find group
            search_url = "https://search.maven.org/solrsearch/select"
            search_params = {
                "q": f"a:{artifact}",
                "rows": 1,
                "wt": "json"
            }
            search_response = requests.get(search_url, params=search_params, timeout=10)
            if search_response.status_code == 200:
                search_data = search_response.json()
                docs = search_data.get("response", {}).get("docs", [])
                if docs:
                    group = docs[0].get("g")  # groupId
                    if not group:
                        return success({
                            "group": "",
                            "artifact": artifact,
                            "version": version,
                            "ecosystem": "Maven",
                            "exists": False,
                            "error": "Could not find group for artifact"
                        })
                else:
                    return success({
                        "group": "",
                        "artifact": artifact,
                        "version": version,
                        "ecosystem": "Maven",
                        "exists": False,
                        "error": "Artifact not found"
                    })

        # Now validate with group
        # Maven Central search API
        url = "https://search.maven.org/solrsearch/select"
        params = {
            "q": f"g:{group} AND a:{artifact} AND v:{version}",
            "rows": 1,
            "wt": "json"
        }
        response = requests.get(url, params=params, timeout=10)
        if response.status_code == 200:
            data = response.json()
            docs = data.get("response", {}).get("docs", [])
            if docs:
                return success({
                    "group": group,
                    "artifact": artifact,
                    "version": version,
                    "ecosystem": "Maven",
                    "exists": True
                })
        return success({
            "group": group,
            "artifact": artifact,
            "version": version,
            "ecosystem": "Maven",
            "exists": False
        })
    except Exception as e:
        return failure(str(e))
