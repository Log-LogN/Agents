from mcp.server.fastmcp import FastMCP
from mcp_tools.vulnerability.tools import search_keyword, search_product, get_cvss_score
from mcp_tools.vulnerability.tools import maven_lookup, package_lookup, cross_verify_package
from mcp_tools.vulnerability.tools.version_validator import validate_npm_version, validate_pypi_version, validate_maven_version
from mcp_tools.vulnerability.tools.osv_advisory import get_osv_vuln
from shared.models import HealthResponse
import logging
from shared.request_context import install_request_context, get_session_id, get_request_id

mcp = FastMCP("vulnerability-mcp")
logger = logging.getLogger("vulnerability-mcp")


@mcp.tool()
def tool_cve_search(keyword: str):
    """General CVE keyword search (NVD)"""
    logger.info("tool_call tool_cve_search session_id=%s request_id=%s", get_session_id() or "-", get_request_id() or "-")
    return search_keyword(keyword)


@mcp.tool()
def tool_get_cvss(cve: str):
    """Get CVSS base score for a CVE (best-effort via NVD)."""
    logger.info("tool_call tool_get_cvss session_id=%s request_id=%s cve=%s", get_session_id() or "-", get_request_id() or "-", cve)
    return get_cvss_score(cve)


@mcp.tool()
def tool_product_cve(product: str, version: str):
    """Search CVEs for product + version (Apache, OpenSSL, etc.)"""
    logger.info("tool_call tool_product_cve session_id=%s request_id=%s product=%s version=%s", get_session_id() or "-", get_request_id() or "-", product, version)
    return search_product(product, version)


@mcp.tool()
def tool_osv_maven_group(group: str, artifact: str, version: str):
    """Check Maven dependency via OSV"""
    logger.info("tool_call tool_osv_maven_group session_id=%s request_id=%s", get_session_id() or "-", get_request_id() or "-")
    if group:
        full_artifact = f"{group}:{artifact}"
    else:
        full_artifact = artifact
    return maven_lookup(full_artifact, version)


@mcp.tool()
def tool_osv_package(name: str, version: str, ecosystem: str):
    """Generic OSV lookup (npm, PyPI, Go, etc.)"""
    logger.info("tool_call tool_osv_package session_id=%s request_id=%s ecosystem=%s name=%s", get_session_id() or "-", get_request_id() or "-", ecosystem, name)
    return package_lookup(name, version, ecosystem)


@mcp.tool()
def tool_validate_npm(package: str, version: str):
    """Validate if npm package version exists"""
    logger.info("tool_call tool_validate_npm session_id=%s request_id=%s package=%s version=%s", get_session_id() or "-", get_request_id() or "-", package, version)
    return validate_npm_version(package, version)


@mcp.tool()
def tool_validate_pypi(package: str, version: str):
    """Validate if PyPI package version exists"""
    logger.info("tool_call tool_validate_pypi session_id=%s request_id=%s package=%s version=%s", get_session_id() or "-", get_request_id() or "-", package, version)
    return validate_pypi_version(package, version)


@mcp.tool()
def tool_validate_maven(group: str, artifact: str, version: str):
    """Validate if Maven artifact version exists"""
    logger.info("tool_call tool_validate_maven session_id=%s request_id=%s", get_session_id() or "-", get_request_id() or "-")
    return validate_maven_version(group, artifact, version)


@mcp.tool()
def tool_cross_verify(group: str, name: str, version: str, ecosystem: str):
    """Cross-verify vulnerabilities using OSV and NVD"""
    logger.info("tool_call tool_cross_verify session_id=%s request_id=%s ecosystem=%s name=%s", get_session_id() or "-", get_request_id() or "-", ecosystem, name)
    if ecosystem.lower() == "maven" and group:
        full_name = f"{group}:{name}"
    else:
        full_name = name
    return cross_verify_package(full_name, version, ecosystem)

@mcp.tool()
async def tool_get_advisory(vuln_id: str):
    """Get advisory/vulnerability details by ID (GHSA/CVE) from OSV."""
    logger.info("tool_call tool_get_advisory session_id=%s request_id=%s vuln_id=%s", get_session_id() or "-", get_request_id() or "-", vuln_id)
    return await get_osv_vuln(vuln_id)


def create_app():
    from fastapi import FastAPI

    # Create a FastAPI app and mount the MCP SSE app
    app = FastAPI()
    sse_app = mcp.sse_app()

    # Mount the SSE app at the root path
    app.mount("/", sse_app)

    @app.get("/health", response_model=HealthResponse)
    async def health():
        return HealthResponse(service="vulnerability-mcp")

    install_request_context(app, service_name="vulnerability-mcp", logger=logger)
    return app
