from mcp.server.fastmcp import FastMCP
from mcp_tools.vulnerability.tools import search_keyword, search_product, get_cvss_score
from mcp_tools.vulnerability.tools import maven_lookup, package_lookup, cross_verify_package
from mcp_tools.vulnerability.tools.version_validator import validate_npm_version, validate_pypi_version, validate_maven_version
from shared.models import HealthResponse

mcp = FastMCP("vulnerability-mcp")


@mcp.tool()
def tool_cve_search(keyword: str):
    """General CVE keyword search (NVD)"""
    return search_keyword(keyword)


@mcp.tool()
def tool_get_cvss(cve: str):
    """Get CVSS base score for a CVE (best-effort via NVD)."""
    return get_cvss_score(cve)


@mcp.tool()
def tool_product_cve(product: str, version: str):
    """Search CVEs for product + version (Apache, OpenSSL, etc.)"""
    return search_product(product, version)


@mcp.tool()
def tool_osv_maven_group(group: str, artifact: str, version: str):
    """Check Maven dependency via OSV"""
    if group:
        full_artifact = f"{group}:{artifact}"
    else:
        full_artifact = artifact
    return maven_lookup(full_artifact, version)


@mcp.tool()
def tool_osv_package(name: str, version: str, ecosystem: str):
    """Generic OSV lookup (npm, PyPI, Go, etc.)"""
    return package_lookup(name, version, ecosystem)


@mcp.tool()
def tool_validate_npm(package: str, version: str):
    """Validate if npm package version exists"""
    return validate_npm_version(package, version)


@mcp.tool()
def tool_validate_pypi(package: str, version: str):
    """Validate if PyPI package version exists"""
    return validate_pypi_version(package, version)


@mcp.tool()
def tool_validate_maven(group: str, artifact: str, version: str):
    """Validate if Maven artifact version exists"""
    return validate_maven_version(group, artifact, version)


@mcp.tool()
def tool_cross_verify(group: str, name: str, version: str, ecosystem: str):
    """Cross-verify vulnerabilities using OSV and NVD"""
    if ecosystem.lower() == "maven" and group:
        full_name = f"{group}:{name}"
    else:
        full_name = name
    return cross_verify_package(full_name, version, ecosystem)


def create_app():
    from fastapi import FastAPI

    # Create a FastAPI app and mount the MCP SSE app
    app = FastAPI()
    sse_app = mcp.sse_app()

    # Mount the SSE app at the root path
    app.mount("/", sse_app)

    @app.get("/health", response_model=HealthResponse)
    async def health():
        return HealthResponse(service="vulnerability-mcp")

    return app
